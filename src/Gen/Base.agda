{-# OPTIONS --type-in-type #-}

open import src.Data
open import Level using (_âŠ”_)

open import Data.Nat hiding (_âŠ”_)
open import Data.Bool
open import Data.List using (List; map; [_]; concatMap; []; _âˆ·_; _++_)
open import Data.Product using (Î£; Î£-syntax; _,_; _Ã—_)
open import Data.Unit
open import Data.Fin
open import Data.Maybe using (Maybe; just; nothing)

open import Category.Functor
open import Category.Applicative
open import Category.Monad

open import Function

open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl)

module src.Gen.Base where

  -- The generator type. The `a` type parameter marks the output type of the
  -- generator. The resultin type family is indexed by a type marking the type
  -- of values produced by recursive positions. 
  data Gen (a : Set) : Set â†’ Set where

    -- Marks choice between generators
    _âˆ¥_   : âˆ€ {t : Set} â†’ Gen a t â†’ Gen a t â†’ Gen a t

    -- Applies the values generated by one generator to another
    Ap    : âˆ€ {b t : Set} â†’ Gen (b â†’ a) t â†’ Gen b t â†’ Gen a t

    -- Lift a single value into the generator type
    Pure  : âˆ€ {t : Set} â†’ a â†’ Gen a t

    -- Monadic bind for generators
    Bind  : âˆ€ {b t : Set} â†’ Gen b t â†’ (b â†’ Gen a t) â†’ Gen a t

    -- Generator that produces no elements at all. 
    None  : âˆ€ {t : Set} â†’ Gen a t

    -- Marks a recursive positions
    Î¼     : Gen a a

    -- Call to an external generator. Using this constructor is
    -- only different from including the generator itself if the
    -- called generator itself contains one or more recursive
    -- positions. 
    `_    : âˆ€ {t : Set} â†’ Gen a a â†’ Gen a t

  -- Type synonym for 'closed' generators, e.g. generators whose recursive
  -- positions refer to the same type as the generator as a whole. 
  ğ”¾ : Set â†’ Set
  ğ”¾ a = Gen a a

  -- Type synonym for 'closed' generators for function types
  coğ”¾ : Set â†’ Set
  coğ”¾ a = âˆ€ {b : Set} â†’ ğ”¾ b â†’ ğ”¾ (a â†’ b)

  -- 'Functor' instance for the generator type
  instance
    Gen-functor : âˆ€ {t : Set} â†’ RawFunctor (Î» a â†’ Gen a t)
    Gen-functor = record { _<$>_ = Ap âˆ˜ Pure }

  -- 'Applicative' instance for the generator type
  instance
    Gen-applicative : âˆ€ {t : Set} â†’ RawApplicative Î» a â†’ Gen a t
    Gen-applicative = record { pure = Pure 
                           ; _âŠ›_  = Ap
                           }

  -- Bring 'Applicative' and 'Functor' into scope
  open RawFunctor â¦ƒ...â¦„ using (_<$>_)
  open RawApplicative â¦ƒ...â¦„ using (pure; _âŠ›_)
  
  -- We need this to allow the use of idiom brackets
  _<*>_ : âˆ€ {â„“} {a b : Set â„“} {f : Set â„“ â†’ Set â„“}
            â¦ƒ _ : RawApplicative f â¦„
          â†’ f (a â†’ b) â†’ f a â†’ f b
  _<*>_ = _âŠ›_

  -- 'Monad' instance for the generator type
  instance
    Gen-monad : âˆ€ {t : Set} â†’ RawMonad Î» a â†’ Gen a t
    Gen-monad =
      record { return = Pure
             ; _>>=_  = Bind
             }

  -- Interpretation function for generators. Interprets a a value of the Gen type as a
  -- function from `â„•` to `List a`.
  --
  -- The first parameter is the generator to be interpreted, the second parameter is a
  -- closed generator that is referred to by recursive positions.
  interpret : âˆ€ {a t : Set} â†’ Gen a t â†’ ğ”¾ t â†’ â„• â†’ List a
  interpret (g         ) tg zero = []
  interpret (gâ‚ âˆ¥ gâ‚‚   ) tg (suc n) =
    merge (interpret gâ‚ tg (suc n)) (interpret gâ‚‚ tg (suc n))
  interpret (Ap gâ‚ gâ‚‚  ) tg (suc n) =
    concatMap (Î» f â†’ map f (interpret gâ‚‚ tg (suc n))) (interpret gâ‚ tg (suc n))
  interpret (Pure x    ) tg (suc n) = [ x ]
  interpret (Bind gâ‚ gâ‚‚) tg (suc n) =
    (flip concatMap) (interpret gâ‚ tg (suc n)) (Î» x â†’ interpret (gâ‚‚ x) tg (suc n))
  interpret (None      ) tg (suc n) = []
  interpret (Î¼         ) tg (suc n) =
    interpret tg tg n
  interpret (` g       ) tg (suc n) =
    interpret g g (suc n)

  -- Interpret a closed generator as a function from `â„•` to `List a`
  âŸ¨_âŸ© : âˆ€ {a : Set} â†’ Gen a a â†’ â„• â†’ List a
  âŸ¨ g âŸ© = interpret g g
  
{-
  infix 3 ã€–_
  infix 1 _ã€—
  infixl 2 _â‹_

  ã€–_ : âˆ€ {i : Set} {a : i â†’ Set} â†’ âŸª ğ”¾áµ¢ a âŸ« â†’ List âŸª ğ”¾áµ¢ a âŸ«
  ã€– x = [ x ]

  _ã€— : âˆ€ {i : Set} {a : i â†’ Set} â†’ List âŸª ğ”¾áµ¢ a âŸ« â†’ âŸª ğ”¾áµ¢ a âŸ«
  (xs ã€—) Î¼ = choiceáµ¢ (map (Î» x â†’ x Î¼) xs) 

  _â‹_ : âˆ€ {i : Set} {a : i â†’ Set} â†’ List âŸª ğ”¾áµ¢ a âŸ« â†’ âŸª ğ”¾áµ¢ a âŸ« â†’ List âŸª ğ”¾áµ¢ a âŸ«
  xs â‹ x = x âˆ· xs
-}
