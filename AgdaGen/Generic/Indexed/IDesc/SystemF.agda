{-# OPTIONS --type-in-type #-}

open import Data.Nat
open import Data.Char
open import Data.List
open import Data.Product
open import Data.Unit

open import Relation.Nullary
open import Relation.Binary.PropositionalEquality

open import Level

open import AgdaGen.Generic.Isomorphism

open import AgdaGen.Generic.Indexed.IDesc.Universe
open import AgdaGen.Generic.Indexed.IDesc.Generator

module AgdaGen.Generic.Indexed.IDesc.SystemF where

  Id : Set
  Id = â„•

  data Î»2 : Set where
    `_   : Id â†’ Î»2
    _Â·_  : Î»2 â†’ Î»2 â†’ Î»2
    Æ›_â‡’_ : Id â†’ Î»2 â†’ Î»2

  data ğ•‹ : Set where
    ``_  : Id â†’ ğ•‹
    _`â†’_ : ğ•‹ â†’ ğ•‹ â†’ ğ•‹
    `âˆ€_Â·_  : Id â†’ ğ•‹ â†’ ğ•‹
 
  data Ctx : Set where
    âˆ… : Ctx
    _,_âˆ¶_ : Ctx â†’ Id â†’ ğ•‹ â†’ Ctx

  data _âˆ‹_ : Ctx â†’ ğ•‹ â†’ Set where
  
    [Top] : âˆ€ {Î“ Ï„ Î±}
          -----------------
          â†’ (Î“ , Î± âˆ¶ Ï„) âˆ‹ Ï„
    
    [Pop] : âˆ€ {Î“ Ïƒ Ï„ Î²} â†’ Î“ âˆ‹ Ï„
          ---------------------
          â†’ (Î“ , Î² âˆ¶ Ïƒ) âˆ‹ Ï„

  data _âˆŒâ‚œ_ : ğ•‹ â†’ Id â†’ Set where

   [âˆŒâ‚œ-var] : âˆ€ {Î± Î²} â†’ Â¬ Î± â‰¡ Î²
            ---------------------
            â†’ (`` Î²) âˆŒâ‚œ Î±

   [âˆŒâ‚œ-fty] : âˆ€ {Î± Ï„â‚ Ï„â‚‚} â†’ Ï„â‚ âˆŒâ‚œ Î± â†’ Ï„â‚‚ âˆŒâ‚œ Î±
            ---------------------------------
            â†’ (Ï„â‚ `â†’ Ï„â‚‚) âˆŒâ‚œ Î±

   [âˆŒâ‚œ-âˆ€Â¬â‰¡] : âˆ€ {Î± Î² Ï„} â†’ Â¬ Î± â‰¡ Î²
            ---------------------
            â†’ (`âˆ€ Î² Â· Ï„) âˆŒâ‚œ Î±

   [âˆŒâ‚œ-âˆ€â‰¡]  : âˆ€ {Î± Ï„}
            -----------------
            â†’ (`âˆ€ Î± Â· Ï„) âˆŒâ‚œ Î±    
    

  data _âˆŒ_ : Ctx â†’ Id â†’ Set where
  
    [âˆŒâ‚] : âˆ€ {Î±}
         -------
         â†’ âˆ… âˆŒ Î±
    
    [âˆŒâ‚‚] : âˆ€ {Î“ Î± x Ï„} â†’ Î“ âˆŒ Î± â†’ Ï„ âˆŒâ‚œ Î±
         ------------------------------
         â†’ (Î“ , x âˆ¶ Ï„) âˆŒ Î± 

  data _[_:=_]â†’_ : ğ•‹ â†’ Id â†’ ğ•‹ â†’ ğ•‹ â†’ Set where
  
    [sub-var] : âˆ€ {Î² Ï„}
              ----------------------
              â†’ (`` Î²) [ Î² := Ï„ ]â†’ Ï„
    
    [sub-fty] : âˆ€ {Î± Ïƒâ‚ Ïƒâ‚‚ Ï„ Ï„â‚ Ï„â‚‚} â†’ Ïƒâ‚ [ Î± := Ï„ ]â†’ Ï„â‚ â†’ Ïƒâ‚‚ [ Î± := Ï„ ]â†’ Ï„â‚‚
              -------------------------------------------------------------
              â†’ (Ïƒâ‚ `â†’ Ïƒâ‚‚) [ Î± := Ï„ ]â†’ (Ï„â‚ `â†’ Ï„â‚‚)
              
    [sub-all] : âˆ€ {Î± Î² Ïƒ Ï„ Ï„'} â†’ Â¬ Î± â‰¡ Î² â†’ Ïƒ [ Î± := Ï„ ]â†’ Ï„'
              ---------------------------------------------
              â†’ (`âˆ€ Î² Â· Ïƒ) [ Î± := Ï„ ]â†’ Ï„'

  infix 10 _âŠ¢_
  infix 15 _,_âˆ¶_

  data _âŠ¢_ : Ctx â†’ ğ•‹ â†’ Set where

    [Î»2-var] : âˆ€ {Î“ Ïƒ} â†’ Î“ âˆ‹ Ïƒ
             -----------------
             â†’ Î“ âŠ¢ Ïƒ

    [Î»2-app] : âˆ€ {Î“ Ïƒ Ï„} â†’ Î“ âŠ¢ (Ïƒ `â†’ Ï„) â†’ Î“ âŠ¢ Ïƒ
             ----------------------------------
             â†’ Î“ âŠ¢  Ï„

    [Î»2-abs] : âˆ€ {Î“ x Ïƒ Ï„} â†’ (Î“ , x âˆ¶ Ïƒ) âŠ¢ Ï„
             -------------------------------
             â†’ Î“ âŠ¢ (Ïƒ `â†’ Ï„)

    [Î»2-âˆ€â‚]  : âˆ€ {Î“ Î± Ïƒ Ï„ Ï„'} â†’ Î“ âŠ¢ (`âˆ€ Î± Â· Ïƒ) â†’ Ïƒ [ Î± := Ï„ ]â†’ Ï„' 
             ----------------------------------------------------
             â†’ Î“ âŠ¢ Ï„'

    [Î»2-âˆ€â‚‚]  : âˆ€ {Î“ Î± Ïƒ} â†’ Î“ âŠ¢ Ïƒ â†’ Î“ âˆŒ Î± 
             ---------------------------
             â†’ Î“ âŠ¢ ( `âˆ€ Î± Â· Ïƒ)


  Î»2D : func 0â„“ (Ctx Ã— ğ•‹) (Ctx Ã— ğ•‹)
  Î»2D = func.mk Î»
    { (Î“ , (`` Î±)) â†’ `Ïƒ 3
    Â    Î» { âˆ™       â†’ Î»2-var-desc Î“ (`` Î±)
          ; (â–» âˆ™)   â†’ Î»2-app-desc Î“ (`` Î±)
          ; (â–» â–» âˆ™) â†’ Î»2-âˆ€â‚-desc  Î“ (`` Î±) 
          } 
    ; (Î“ , (Ï„â‚ `â†’ Ï„â‚‚)) â†’ `Ïƒ 4
        Î» { âˆ™         â†’ Î»2-var-desc Î“ (Ï„â‚ `â†’ Ï„â‚‚)
          ; (â–» âˆ™)     â†’ Î»2-app-desc Î“ (Ï„â‚ `â†’ Ï„â‚‚) 
          ; (â–» â–» âˆ™)   â†’ Î»2-abs-desc Î“ Ï„â‚ Ï„â‚‚
          ; (â–» â–» â–» âˆ™) â†’ Î»2-âˆ€â‚-desc Î“ (Ï„â‚ `â†’ Ï„â‚‚)
          } 
    ; (Î“ , (`âˆ€ Î± Â· Ï„)) â†’ `Ïƒ 4
        Î» { âˆ™         â†’ Î»2-var-desc Î“ (`âˆ€ Î± Â· Ï„)
          ; (â–» âˆ™)     â†’ Î»2-app-desc Î“ (`âˆ€ Î± Â· Ï„)
          ; (â–» â–» âˆ™)   â†’ Î»2-âˆ€â‚-desc Î“ (`âˆ€ Î± Â· Ï„)
          ; (â–» â–» â–» âˆ™) â†’ Î»2-âˆ€â‚‚-desc Î“ Î± Ï„ 
          }
    } where -- [Î»2-var]
            Î»2-var-desc : Ctx â†’ ğ•‹ â†’ IDesc 0â„“ (Ctx Ã— ğ•‹)
            Î»2-var-desc Î“ Ï„ = `Î£ (Î“ âˆ‹ Ï„) Î» _ â†’ `1

            -- [Î»2-app]
            Î»2-app-desc : Ctx â†’ ğ•‹ â†’ IDesc 0â„“ (Ctx Ã— ğ•‹)
            Î»2-app-desc Î“ Ï„ = `Î£ ğ•‹ Î» Ïƒ â†’ `var (Î“ , (Ïƒ `â†’ Ï„)) `Ã— `var (Î“ , Ïƒ)

            -- [Î»2-abs]
            Î»2-abs-desc : Ctx â†’ ğ•‹ â†’ ğ•‹ â†’ IDesc 0â„“ (Ctx Ã— ğ•‹)
            Î»2-abs-desc Î“ Ïƒ Ï„ = `Î£ Id (Î» x â†’ `var ((Î“ , x âˆ¶ Ïƒ) , Ï„))

            -- [Î»2-âˆ€â‚]
            Î»2-âˆ€â‚-desc  : Ctx â†’ ğ•‹ â†’ IDesc 0â„“ (Ctx Ã— ğ•‹)
            Î»2-âˆ€â‚-desc Î“ Ï„' = `Î£ (Î£ (Id Ã— ğ•‹ Ã— ğ•‹) Î» { (Î± , Ïƒ , Ï„) â†’ Ïƒ [ Î± := Ï„ ]â†’ Ï„' })
              Î» { ( (Î± , Ïƒ , _) , _) â†’ `var (Î“ , `âˆ€ Î± Â· Ïƒ) }

            -- [Î»2-âˆ€â‚‚]
            Î»2-âˆ€â‚‚-desc  : Ctx â†’ Id â†’ ğ•‹ â†’ IDesc 0â„“ (Ctx Ã— ğ•‹)
            Î»2-âˆ€â‚‚-desc Î“ Î± Ïƒ = `Î£ (Î“ âˆŒ Î±) (Î» _ â†’ `var (Î“ , Ïƒ))

  fromâŠ¢ : âˆ€ {Î“ Ï„} â†’ Î“ âŠ¢ Ï„ â†’ Î¼ Î»2D (Î“ , Ï„)
  fromâŠ¢ {Î“} {`` x} ([Î»2-var] xâ‚) =
    âŸ¨ (âˆ™ , xâ‚ , lift tt) âŸ©
  fromâŠ¢ {Î“} {`` x} ([Î»2-app] {Ïƒ = Ïƒ} p pâ‚) =
    âŸ¨ ((â–» âˆ™) , Ïƒ , fromâŠ¢ p , fromâŠ¢ pâ‚) âŸ©
  fromâŠ¢ {Î“} {`` x} ([Î»2-âˆ€â‚] {Î± = Î±} {Ïƒ = Ïƒ} {Ï„ = Ï„}  p xâ‚) =
    âŸ¨ ((â–» â–» âˆ™) , ((Î± , Ïƒ , Ï„) , xâ‚) , fromâŠ¢ p) âŸ©
  fromâŠ¢ {Î“} {Ï„ `â†’ Ï„â‚} ([Î»2-var] x) =
    âŸ¨ âˆ™ , (x , lift tt) âŸ©
  fromâŠ¢ {Î“} {Ï„ `â†’ Ï„â‚} ([Î»2-app] {Ïƒ = Ïƒ} p pâ‚) =
    âŸ¨ (â–» âˆ™ , Ïƒ , fromâŠ¢ p , fromâŠ¢ pâ‚) âŸ©
  fromâŠ¢ {Î“} {Ï„ `â†’ Ï„â‚} ([Î»2-abs] {x = x} p) = âŸ¨ ((â–» â–» âˆ™) , (x , fromâŠ¢ p)) âŸ©
  fromâŠ¢ {Î“} {Ï„â‚ `â†’ Ï„â‚‚} ([Î»2-âˆ€â‚] {Î± = Î±} {Ïƒ = Ïƒ} {Ï„ = Ï„} p x) =
    âŸ¨ ((â–» â–» â–» âˆ™) , ((Î± , Ïƒ , Ï„) , x) , fromâŠ¢ p) âŸ©
  fromâŠ¢ {Î“} {`âˆ€ x Â· Ï„} ([Î»2-var] xâ‚) =
    âŸ¨ (âˆ™ , (xâ‚ , lift tt)) âŸ©
  fromâŠ¢ {Î“} {`âˆ€ x Â· Ï„} ([Î»2-app] {Ïƒ = Ïƒ} p pâ‚) =
    âŸ¨ ((â–» âˆ™) , (Ïƒ , fromâŠ¢ p , fromâŠ¢ pâ‚)) âŸ©
  fromâŠ¢ {Î“} {`âˆ€ x Â· Ï„'} ([Î»2-âˆ€â‚] {Î± = Î±} {Ïƒ = Ïƒ} {Ï„ = Ï„} p xâ‚) =
    âŸ¨ ((â–» â–» âˆ™) , ((Î± , Ïƒ , Ï„) , xâ‚) , fromâŠ¢ p) âŸ©
  fromâŠ¢ {Î“} {`âˆ€ x Â· Ï„} ([Î»2-âˆ€â‚‚] p xâ‚) =
    âŸ¨ ((â–» â–» â–» âˆ™) , (xâ‚ , fromâŠ¢ p)) âŸ©

  toâŠ¢ : âˆ€ {Î“ Ï„} â†’ Î¼ Î»2D (Î“ , Ï„) â†’ Î“ âŠ¢ Ï„
  toâŠ¢ {Î“} {`` x} âŸ¨ âˆ™ , fst , snd âŸ© =
    [Î»2-var] fst
  toâŠ¢ {Î“} {`` x} âŸ¨ â–» âˆ™ , fst , fstâ‚ , snd âŸ© =
    [Î»2-app] {Ïƒ = fst} (toâŠ¢ fstâ‚) (toâŠ¢ snd)
  toâŠ¢ {Î“} {`` x} âŸ¨ â–» â–» âˆ™ , ((Î± , Ïƒ , Ï„) , snd) , sndâ‚ âŸ© =
    [Î»2-âˆ€â‚] {Î± = Î±} {Ïƒ = Ïƒ} {Ï„ = Ï„} (toâŠ¢ sndâ‚) snd
  toâŠ¢ {Î“} {Ï„ `â†’ Ï„â‚} âŸ¨ âˆ™ , fst , snd âŸ© =
    [Î»2-var] fst
  toâŠ¢ {Î“} {Ï„ `â†’ Ï„â‚} âŸ¨ â–» âˆ™ , fst , fstâ‚ , snd âŸ© =
    [Î»2-app] {Ïƒ = fst} (toâŠ¢ fstâ‚) (toâŠ¢ snd)
  toâŠ¢ {Î“} {Ï„ `â†’ Ï„â‚} âŸ¨ â–» â–» âˆ™ , fst , snd âŸ© =
    [Î»2-abs] {x = fst} (toâŠ¢ snd)
  toâŠ¢ {Î“} {Ï„â‚ `â†’ Ï„â‚‚} âŸ¨ â–» â–» â–» âˆ™ , ((Î± , Ïƒ , Ï„) , snd) , sndâ‚ âŸ© =
    [Î»2-âˆ€â‚] {Î± = Î±} {Ïƒ = Ïƒ} {Ï„ = Ï„} (toâŠ¢ sndâ‚) snd
  toâŠ¢ {Î“} {`âˆ€ x Â· Ï„} âŸ¨ âˆ™ , fst , snd âŸ© =
    [Î»2-var] fst
  toâŠ¢ {Î“} {`âˆ€ x Â· Ï„} âŸ¨ â–» âˆ™ , fst , fstâ‚ , snd âŸ© =
    [Î»2-app] {Ïƒ = fst} (toâŠ¢ fstâ‚) (toâŠ¢ snd) 
  toâŠ¢ {Î“} {`âˆ€ x Â· Ï„'} âŸ¨ â–» â–» âˆ™ , ((Î± , Ïƒ , Ï„) , snd) , sndâ‚ âŸ© =
    [Î»2-âˆ€â‚] {Î± = Î±} {Ïƒ = Ïƒ} {Ï„ = Ï„} (toâŠ¢ sndâ‚) snd
  toâŠ¢ {Î“} {`âˆ€ x Â· Ï„} âŸ¨ â–» â–» â–» âˆ™ , fst , snd âŸ© =
    [Î»2-âˆ€â‚‚] (toâŠ¢ snd) fst

  âŠ¢-isoâ‚ : âˆ€ {Î“ Ï„} {p : Î“ âŠ¢ Ï„} â†’ toâŠ¢ (fromâŠ¢ p) â‰¡ p
  âŠ¢-isoâ‚ {Î“} {`` x} {[Î»2-var] xâ‚} = refl
  âŠ¢-isoâ‚ {Î“} {`` x} {[Î»2-app] pâ‚ pâ‚‚} =
    congâ‚‚ [Î»2-app] âŠ¢-isoâ‚ âŠ¢-isoâ‚
  âŠ¢-isoâ‚ {Î“} {`` x} {[Î»2-âˆ€â‚] p xâ‚} =
    cong (Î» p â†’ [Î»2-âˆ€â‚] p xâ‚) âŠ¢-isoâ‚
  âŠ¢-isoâ‚ {Î“} {Ï„ `â†’ Ï„â‚} {[Î»2-var] x} = refl
  âŠ¢-isoâ‚ {Î“} {Ï„ `â†’ Ï„â‚} {[Î»2-app] p pâ‚} =
    congâ‚‚ [Î»2-app] âŠ¢-isoâ‚ âŠ¢-isoâ‚
  âŠ¢-isoâ‚ {Î“} {Ï„ `â†’ Ï„â‚} {[Î»2-abs] p} =
    cong [Î»2-abs] âŠ¢-isoâ‚
  âŠ¢-isoâ‚ {Î“} {Ï„ `â†’ Ï„â‚} {[Î»2-âˆ€â‚] p x} =
    cong (Î» p â†’ [Î»2-âˆ€â‚] p x) âŠ¢-isoâ‚
  âŠ¢-isoâ‚ {Î“} {`âˆ€ x Â· Ï„} {[Î»2-var] xâ‚} = refl
  âŠ¢-isoâ‚ {Î“} {`âˆ€ x Â· Ï„} {[Î»2-app] p pâ‚} =
    congâ‚‚ [Î»2-app] âŠ¢-isoâ‚ âŠ¢-isoâ‚
  âŠ¢-isoâ‚ {Î“} {`âˆ€ x Â· Ï„} {[Î»2-âˆ€â‚] p xâ‚} =
    cong (Î» p â†’ [Î»2-âˆ€â‚] p xâ‚) âŠ¢-isoâ‚
  âŠ¢-isoâ‚ {Î“} {`âˆ€ x Â· Ï„} {[Î»2-âˆ€â‚‚] p xâ‚} =
    cong (Î» p â†’ [Î»2-âˆ€â‚‚] p xâ‚) âŠ¢-isoâ‚

  âŠ¢-isoâ‚‚ : âˆ€ {Î“ Ï„} {p : Î¼ Î»2D (Î“ , Ï„)} â†’ fromâŠ¢ (toâŠ¢ p ) â‰¡ p
  âŠ¢-isoâ‚‚ {Î“} {`` x} {âŸ¨ âˆ™ , fst , lift tt âŸ©} = refl
  âŠ¢-isoâ‚‚ {Î“} {`` x} {âŸ¨ â–» âˆ™ , (Ïƒ , l , r) âŸ©} =
    congâ‚‚ (Î» x y â†’ âŸ¨ ((â–» âˆ™) , Ïƒ , x , y) âŸ©) âŠ¢-isoâ‚‚ âŠ¢-isoâ‚‚
  âŠ¢-isoâ‚‚ {Î“} {`` x} {âŸ¨ â–» â–» âˆ™ , ((Î± , Ïƒ , Ï„) , snd) , sndâ‚ âŸ©} =
    cong (Î» x â†’ âŸ¨ ((â–» â–» âˆ™) , ((Î± , Ïƒ , Ï„) , snd) , x) âŸ©) âŠ¢-isoâ‚‚
  âŠ¢-isoâ‚‚ {Î“} {Ï„ `â†’ Ï„â‚} {âŸ¨ âˆ™ , fst , lift tt âŸ©} = refl
  âŠ¢-isoâ‚‚ {Î“} {Ï„ `â†’ Ï„â‚} {âŸ¨ â–» âˆ™ , Ïƒ , fstâ‚ , snd âŸ©} =
    congâ‚‚ (Î» x y â†’ âŸ¨ ((â–» âˆ™) , (Ïƒ , x , y)) âŸ©) âŠ¢-isoâ‚‚ âŠ¢-isoâ‚‚
  âŠ¢-isoâ‚‚ {Î“} {Ï„ `â†’ Ï„â‚} {âŸ¨ â–» â–» âˆ™ , fst , snd âŸ©} =
    cong (Î» x â†’ âŸ¨ (â–» â–» âˆ™ , fst , x) âŸ©) âŠ¢-isoâ‚‚
  âŠ¢-isoâ‚‚ {Î“} {Ï„â‚ `â†’ Ï„â‚‚} {âŸ¨ â–» â–» â–» âˆ™ , ((Î± , Ïƒ , Ï„) , snd) , sndâ‚ âŸ©} =
    cong (Î» x â†’ âŸ¨ (â–» â–» â–» âˆ™ , ((Î± , Ïƒ , Ï„) , snd) , x) âŸ©) âŠ¢-isoâ‚‚
  âŠ¢-isoâ‚‚ {Î“} {`âˆ€ x Â· Ï„} {âŸ¨ âˆ™ , snd âŸ©} = refl
  âŠ¢-isoâ‚‚ {Î“} {`âˆ€ x Â· Ï„} {âŸ¨ â–» âˆ™ , Ïƒ , fstâ‚ , snd âŸ©} =
    congâ‚‚ (Î» x y â†’ âŸ¨ ((â–» âˆ™) , Ïƒ , x , y) âŸ©) âŠ¢-isoâ‚‚ âŠ¢-isoâ‚‚
  âŠ¢-isoâ‚‚ {Î“} {`âˆ€ x Â· Ï„'} {âŸ¨ â–» â–» âˆ™ , ((Î± , Ïƒ , Ï„) , snd) , sndâ‚ âŸ©} =
    cong (Î» x â†’ âŸ¨ (â–» â–» âˆ™ , ((Î± , Ïƒ , Ï„) , snd) , x) âŸ©) âŠ¢-isoâ‚‚
  âŠ¢-isoâ‚‚ {Î“} {`âˆ€ x Â· Ï„} {âŸ¨ â–» â–» â–» âˆ™ , fst , snd âŸ©} =
    cong (Î» x â†’ âŸ¨ ((â–» â–» â–» âˆ™) , fst , x) âŸ©) âŠ¢-isoâ‚‚

  instance
    âŠ¢â‰…IDesc : â‰…IDesc {I = Ctx Ã— ğ•‹}  Î» { (Î“ , Ï„) â†’ Î“ âŠ¢ Ï„ }
    âŠ¢â‰…IDesc = record {
      W = Î»2D , â‰…-transitive (â‰…-symmetric â‰…lift) (
        record { from = fromâŠ¢
               ; to   = toâŠ¢
               ; isoâ‚ = âŠ¢-isoâ‚
               ; isoâ‚‚ = âŠ¢-isoâ‚‚
               }) }
