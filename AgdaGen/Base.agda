open import AgdaGen.Data
open import Level renaming (suc to sucL ; zero to zeroL)

open import Data.Nat hiding (_âŠ”_)
open import Data.Bool
open import Data.List using (List; map; [_]; concatMap; []; _âˆ·_; _++_)
open import Data.Product using (Î£; Î£-syntax; _,_; _Ã—_)
open import Data.Unit
open import Data.Fin hiding (lift; _+_)
open import Data.Maybe using (Maybe; just; nothing)

open import Function

open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl)

module AgdaGen.Base where

  data Func {â„“} (A B : Set â„“) : Set â„“ where
    Store : (A â†’ B) â†’ Func A B 

  mutual
    -- The generator type. The `a` type parameter marks the output type of the
    -- generator. The resulting family is indexed by a type marking the type
    -- of values produced by recursive positions.
    data Gen {â„“ k} : (a : Set â„“) â†’ (t : Set â„“) â†’ Set (sucL k âŠ” sucL â„“) where
  
      -- Marks choice between generators
      Or   : âˆ€ {a t : Set â„“} â†’ Gen {â„“} {k} a t â†’ Gen {â„“} {k} a t â†’ Gen a t

      -- Applies the values generated by one generator to another
      Ap    : âˆ€ {a t b : Set â„“} â†’ Gen {â„“} {k} (b â†’ a) t â†’ Gen {â„“} {k} b t  â†’ Gen a t

      -- Lift a single value into the generator type
      Pure  : âˆ€ {a t : Set â„“} â†’ a â†’ Gen a t

      -- Monadic bind for generators
      Bind  : âˆ€ {a b t : Set â„“} â†’ Gen {â„“} {k} b t â†’ (b â†’ Gen {â„“} {k} a t) â†’ Gen a t 

        -- Generator that produces no elements at all. 
      None  : âˆ€ {a t : Set â„“} â†’ Gen a t

      -- Marks a recursive positions
      Î¼     : âˆ€ {a : Set â„“} â†’ Gen a a

      -- Call to an external generator. Using this constructor is
      -- only different from including the generator itself if the
      -- called generator contains one or more recursive
      -- positions. 
      `_    : âˆ€ {a t : Set â„“} â†’ Gen {â„“} {k} a a â†’ Gen a t

      âŸ¨_`_âŸ© : âˆ€ {i : Set k} {p : i â†’ Set â„“} {t : Set â„“} â†’ (x : i) â†’ ((x : i) â†’ Genáµ¢ (p x) p x) â†’ Gen (p x) t

    data Genáµ¢ {â„“ k} {i : Set k} : 
      (Set â„“) â†’ (i â†’ Set â„“) â†’ i â†’ Set (sucL k âŠ” sucL â„“) where

      -- Lifts values into the Genáµ¢ type
      Pureáµ¢ : âˆ€ {a : Set â„“} {t : i â†’ Set â„“} {x : i} â†’ a â†’ Genáµ¢ a t x

      -- Aplies the results of one generator to the results of another
      Apáµ¢   : âˆ€ {a b : Set â„“} {t : i â†’ Set â„“} {x : i} {y : i} 
            â†’ Genáµ¢ (b â†’ a) t x â†’ Genáµ¢ b t y â†’ Genáµ¢ a t x

      -- Monadic bind for generators
      Bindáµ¢ : âˆ€ {a b : Set â„“} {t : i â†’ Set â„“} {x : i} {y : i}
            â†’ Genáµ¢ a t y â†’ (a â†’ Genáµ¢ b t x) â†’ Genáµ¢ b t x

      -- Choice between generators
      Oráµ¢  : âˆ€ {a : Set â„“} {t : i â†’ Set â„“} {x : i}
             â†’ Genáµ¢ a t x â†’ Genáµ¢ a t x â†’ Genáµ¢ a t x

      -- Recursive positions
      Î¼áµ¢    : âˆ€ {a : i â†’ Set â„“} â†’ (x : i) â†’ Genáµ¢ (a x) a x

      -- Empty generator
      Noneáµ¢ : âˆ€ {a : Set â„“} {t : i â†’ Set â„“} {x : i} â†’ Genáµ¢ a t x

      -- Call to external non-indexed generator
      Call  : âˆ€ {t : i â†’ Set â„“} {x : i} {b : Set â„“} â†’ Gen {â„“} {k} b b â†’ Genáµ¢ b t x

      -- Call to external indexed generator
      Calláµ¢ : âˆ€ {j : Set k} {t : i â†’ Set â„“} {s : j â†’ Set â„“} {x : i} â†’ (y : j) â†’ ((y' : j) â†’ Genáµ¢ (s y') s y') â†’ Genáµ¢ (s y) t x

  -- Type synonym for 'closed' generators, e.g. generators whose recursive
  -- positions refer to the same type as the generator as a whole. 
  ğ”¾ : âˆ€ {â„“ k} â†’ Set â„“ â†’ Set (Level.suc â„“ âŠ” sucL k)
  ğ”¾ {â„“} {k} a = Gen {â„“} {k} a a

  -- The type of closed indexed generators
  ğ”¾áµ¢ : âˆ€ {â„“ k} {i : Set k} â†’ (i â†’ Set â„“) â†’ i â†’ Set (sucL k âŠ” (sucL â„“))
  ğ”¾áµ¢ f x = Genáµ¢ (f x) f x
  
  -- Type synonym for 'closed' generators for function types
  coğ”¾ : âˆ€ {â„“ k} â†’ Set â„“ â†’ Set (sucL â„“ âŠ” sucL k)
  coğ”¾ {â„“} {k} a = âˆ€ {b : Set â„“} â†’ ğ”¾ {â„“} {k} b â†’ ğ”¾ {â„“} {k} (a â†’ b)

  -- Indexed functions
  coğ”¾áµ¢ : âˆ€ {â„“ k} {i : Set k} â†’ (i â†’ Set â„“) â†’ i â†’  Set (sucL k âŠ” (sucL â„“))
  coğ”¾áµ¢ {â„“} {k} f x = âˆ€ {b : Set â„“} â†’ ğ”¾ {â„“} {k} b â†’ ğ”¾áµ¢ (Î» x â†’ f x â†’ b) x

  -- Generator interpretations. Map generators to any type, parameterized with
  -- the type of values that are generated
  record âŸ¦GeneratorâŸ§ {â„“ k} (T : Set â„“ â†’ Set â„“) : Set (sucL k âŠ” sucL â„“) where
    field
      âŸ¦_âŸ§gen  : âˆ€ {A : Set â„“} â†’ ğ”¾ {â„“} {k} A â†’ T A
    field
      âŸ¦_âŸ§genáµ¢ : âˆ€ {I : Set k} {P : I â†’ Set â„“} â†’ ((i : I) â†’ ğ”¾áµ¢ P i) â†’ (i : I) â†’ T (P i)

  -- Apply a mapping to a generator
  run :
    âˆ€ {â„“ k} {A : Set â„“} {T : Set â„“ â†’ Set â„“}
      â¦ƒ it : âŸ¦GeneratorâŸ§ {â„“} {k} T â¦„
    â†’ ğ”¾ {â„“} {k} A â†’ T A
  run â¦ƒ it = record { âŸ¦_âŸ§gen = âŸ¦_âŸ§gen ; âŸ¦_âŸ§genáµ¢ = _} â¦„ g =
    âŸ¦ g âŸ§gen

  -- Apply a mapping to an indexed generator
  runáµ¢ :
    âˆ€ {â„“ k} {I : Set k} {T : Set â„“ â†’ Set â„“}
      â¦ƒ it : âŸ¦GeneratorâŸ§ {â„“} {k} T â¦„ {P : I â†’ Set â„“}
    â†’ ((i : I) â†’ ğ”¾áµ¢ P i) â†’ (i : I) â†’ T (P i)
  runáµ¢ â¦ƒ it = record { âŸ¦_âŸ§gen = _ ; âŸ¦_âŸ§genáµ¢ = âŸ¦_âŸ§genáµ¢ } â¦„ g =
    âŸ¦ g âŸ§genáµ¢
