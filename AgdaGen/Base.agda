open import AgdaGen.Data
open import Level using (_âŠ”_)

open import Data.Nat hiding (_âŠ”_)
open import Data.Bool
open import Data.List using (List; map; [_]; concatMap; []; _âˆ·_; _++_)
open import Data.Product using (Î£; Î£-syntax; _,_; _Ã—_)
open import Data.Unit
open import Data.Fin hiding (lift)
open import Data.Maybe using (Maybe; just; nothing)

open import Function

open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl)

module AgdaGen.Base where

  -- The generator type. The `a` type parameter marks the output type of the
  -- generator. The resulting family is indexed by a type marking the type
  -- of values produced by recursive positions. 
  data Gen {â„“} (a : Set â„“) : (t : Set â„“) â†’ Set (Level.suc â„“) where

    -- Marks choice between generators
    _âˆ¥_   : âˆ€ {t : Set â„“} â†’ Gen a t â†’ Gen a t â†’ Gen a t

    -- Applies the values generated by one generator to another
    Ap    : âˆ€ {t b : Set â„“} â†’ Gen (b â†’ a) t â†’ Gen b t  â†’ Gen a t

    -- Lift a single value into the generator type
    Pure  : âˆ€ {t : Set â„“} â†’ a â†’ Gen a t

    -- Monadic bind for generators
    Bind  : âˆ€ {b t : Set â„“} â†’ Gen b t â†’ (b â†’ Gen a t) â†’ Gen a t 

      -- Generator that produces no elements at all. 
    None  : âˆ€ {t : Set â„“} â†’ Gen a t

    -- Marks a recursive positions
    Î¼     : Gen a a

    Î¼'    : âˆ€ {b t : Set â„“} â†’ (Î£[ x âˆˆ b ] ((Î£[ y âˆˆ b ] y â‰¡ x) â†’ Gen a a)) â†’ Gen a t 

    -- Call to an external generator. Using this constructor is
    -- only different from including the generator itself if the
    -- called generator contains one or more recursive
    -- positions. 
    `_    : âˆ€ {t : Set â„“} â†’ Gen a a â†’ Gen a t

  -- Type synonym for 'closed' generators, e.g. generators whose recursive
  -- positions refer to the same type as the generator as a whole. 
  ğ”¾ : âˆ€ {â„“} â†’ Set â„“ â†’ Set (Level.suc â„“)
  ğ”¾ a = Gen a a
  
  -- Type synonym for 'closed' generators for function types
  coğ”¾ : âˆ€ {â„“} â†’ Set â„“ â†’ Set (Level.suc â„“)
  coğ”¾ {â„“} a = âˆ€ {b : Set â„“} â†’ ğ”¾ b â†’ ğ”¾ (a â†’ b)

  -- Interpretation function for generators. Interprets a a value of the Gen type as a
  -- function from `â„•` to `List a`.
  --
  -- The first parameter is the generator to be interpreted, the second parameter is a
  -- closed generator that is referred to by recursive positions.
  interpret : âˆ€ {â„“} {a t : Set â„“} â†’ Gen a t â†’ ğ”¾ t â†’ â„• â†’ List a
  interpret (g         ) tg zero = []
  interpret (gâ‚ âˆ¥ gâ‚‚   ) tg (suc n) =
    merge (interpret gâ‚ tg (suc n)) (interpret gâ‚‚ tg (suc n))
  interpret (Ap gâ‚ gâ‚‚  ) tg (suc n) =
    concatMap (Î» f â†’ map f (interpret gâ‚‚ tg (suc n))) (interpret gâ‚ tg (suc n))
  interpret (Pure x    ) tg (suc n) = [ x ]
  interpret (Bind gâ‚ gâ‚‚) tg (suc n) =
    (flip concatMap) (interpret gâ‚ tg (suc n)) (Î» x â†’ interpret (gâ‚‚ x) tg (suc n))
  interpret (None      ) tg (suc n) = []
  interpret (Î¼         ) tg (suc n) =
    interpret tg tg n
  interpret (` g       ) tg (suc n) =
    interpret g g (suc n)
  interpret (Î¼' (x , f)) tg (suc n) = interpret (f (x , refl)) (f (x , refl)) n

  Mu : âˆ€ {â„“} {i t : Set â„“} {f : i â†’ Set â„“} â†’ ((x : i) â†’ Gen (f x) (f x)) â†’ (x : i) â†’ Gen (f x) t
  Mu f x = Î¼' (x , Î» { (x , refl) â†’ f x })

  infix 3 Mu-syntax

  Mu-syntax : âˆ€ {â„“} {i t : Set â„“} {f : i â†’ Set â„“} â†’ ((x : i) â†’ Gen (f x) (f x)) â†’ (x : i) â†’ Gen (f x) t
  Mu-syntax = Mu

  syntax Mu-syntax f x = Î¼[ f , x ]

  -- Interpret a closed generator as a function from `â„•` to `List a`
  âŸ¨_âŸ© : âˆ€ {â„“} {a : Set â„“} â†’ Gen a a â†’ â„• â†’ List a
  âŸ¨ g âŸ© = interpret g g



