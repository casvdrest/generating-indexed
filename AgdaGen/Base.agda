open import AgdaGen.Data
open import Level renaming (suc to sucL ; zero to zeroL)

open import Data.Nat hiding (_âŠ”_)
open import Data.Bool
open import Data.List using (List; map; [_]; concatMap; []; _âˆ·_; _++_)
open import Data.Product using (Î£; Î£-syntax; _,_; _Ã—_)
open import Data.Unit
open import Data.Fin hiding (lift)
open import Data.Maybe using (Maybe; just; nothing)

open import Function

open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl)

module AgdaGen.Base where

  mutual
    -- The generator type. The `a` type parameter marks the output type of the
    -- generator. The resulting family is indexed by a type marking the type
    -- of values produced by recursive positions. 
    data Gen {â„“ k} : (a : Set â„“) â†’ (t : Set â„“) â†’ Set (sucL k âŠ” sucL â„“) where
  
      -- Marks choice between generators
      Or   : âˆ€ {a t : Set â„“} â†’ Gen {â„“} {k} a t â†’ Gen {â„“} {k} a t â†’ Gen a t

      -- Applies the values generated by one generator to another
      Ap    : âˆ€ {a t b : Set â„“} â†’ Gen {â„“} {k} (b â†’ a) t â†’ Gen {â„“} {k} b t  â†’ Gen a t

      -- Lift a single value into the generator type
      Pure  : âˆ€ {a t : Set â„“} â†’ a â†’ Gen a t

      -- Monadic bind for generators
      Bind  : âˆ€ {a b t : Set â„“} â†’ Gen {â„“} {k} b t â†’ (b â†’ Gen {â„“} {k} a t) â†’ Gen a t 

        -- Generator that produces no elements at all. 
      None  : âˆ€ {a t : Set â„“} â†’ Gen a t

      -- Marks a recursive positions
      Î¼     : âˆ€ {a : Set â„“} â†’ Gen a a

      -- Call to an external generator. Using this constructor is
      -- only different from including the generator itself if the
      -- called generator contains one or more recursive
      -- positions. 
      `_    : âˆ€ {a t : Set â„“} â†’ Gen {â„“} {k} a a â†’ Gen a t

      âŸ¨_`_âŸ© : âˆ€ {i : Set k} {p : i â†’ Set â„“} {t : Set â„“} â†’ (x : i) â†’ ((x : i) â†’ Genáµ¢ p p x) â†’ Gen (p x) t


    data Genáµ¢ {â„“ k} {i : Set k} :
      (i â†’ Set â„“) â†’ (i â†’ Set â„“) â†’ i â†’ Set (sucL k âŠ” sucL â„“) where

      -- Lifts values into the Genáµ¢ type
      Pureáµ¢ : âˆ€ {a t : i â†’ Set â„“} {x : i} â†’ a x â†’ Genáµ¢ a t x

      -- Aplies the results of one generator to the results of another
      Apáµ¢   : âˆ€ {a b t : i â†’ Set â„“} {x : i} {y : i}
            â†’ Genáµ¢ (Î» _ â†’ b y â†’ a x) t x â†’ Genáµ¢ b t y â†’ Genáµ¢ a t x

      -- Monadic bind for generators
      Bindáµ¢ : âˆ€ {a b t : i â†’ Set â„“} {x : i} {y : i}
            â†’ Genáµ¢ a t y â†’ (a y â†’ Genáµ¢ b t x) â†’ Genáµ¢ b t x

      -- Choice between generators
      Oráµ¢  : âˆ€ {a t : i â†’ Set â„“} {x : i}
           â†’ Genáµ¢ a t x â†’ Genáµ¢ a t x â†’ Genáµ¢ a t x

      -- Recursive positions
      Î¼áµ¢    : âˆ€ {a : i â†’ Set â„“} (x : i) â†’ Genáµ¢ a a x

      -- Empty generator
      Noneáµ¢ : âˆ€ {a t : i â†’ Set â„“} {x : i} â†’ Genáµ¢ a t x

      -- Call to external non-indexed generator
      Call  : âˆ€ {t : i â†’ Set â„“} {x : i} {b : Set â„“} â†’ Gen {â„“} {k} b b â†’ Genáµ¢ (Î» _ â†’ b) t x

      -- Call to external indexed generator
      Calláµ¢ : âˆ€ {t : i â†’ Set â„“} {x : i} {j : Set â„“} {s : j â†’ Set â„“}
            â†’ ((y : j) â†’ Genáµ¢ s s y) â†’ (y : j) â†’ Genáµ¢ (Î» _ â†’ s y) t x

  -- Type synonym for 'closed' generators, e.g. generators whose recursive
  -- positions refer to the same type as the generator as a whole. 
  ğ”¾ : âˆ€ {â„“ k} â†’ Set â„“ â†’ Set (Level.suc â„“ âŠ” sucL k)
  ğ”¾ {â„“} {k} a = Gen {â„“} {k} a a

  -- The type of closed indexed generators
  ğ”¾áµ¢ : âˆ€ {â„“ k} {i : Set k} â†’ (i â†’ Set â„“) â†’ i â†’ Set (sucL k âŠ” (sucL â„“))
  ğ”¾áµ¢ f x = Genáµ¢ f f x

  coğ”¾áµ¢ : âˆ€ {â„“ k} {i : Set k} â†’ (i â†’ Set â„“) â†’ i â†’  Set (sucL k âŠ” (sucL â„“))
  coğ”¾áµ¢ {â„“} {k} f x = âˆ€ {b : Set â„“} â†’ ğ”¾ {â„“} {k} b â†’ ğ”¾áµ¢ (Î» x â†’ f x â†’ b) x
  
  -- Type synonym for 'closed' generators for function types
  coğ”¾ : âˆ€ {â„“ k} â†’ Set â„“ â†’ Set (sucL â„“ âŠ” sucL k)
  coğ”¾ {â„“} {k} a = âˆ€ {b : Set â„“} â†’ ğ”¾ {â„“} {k} b â†’ ğ”¾ {â„“} {k} (a â†’ b)

  mutual
    -- Interpretation function for generators. Interprets a a value of the Gen type as a
    -- function from `â„•` to `List a`.
    --
    -- The first parameter is the generator to be interpreted, the second parameter is a
    -- closed generator that is referred to by recursive positions.
    interpret : âˆ€ {â„“ k} {a t : Set â„“} â†’ Gen {â„“} {k} a t â†’ ğ”¾ t â†’ â„• â†’ List a
    interpret (g         ) tg zero = []
    interpret (Or gâ‚ gâ‚‚  ) tg (suc n) =
      merge (interpret gâ‚ tg (suc n)) (interpret gâ‚‚ tg (suc n))
    interpret (Ap gâ‚ gâ‚‚  ) tg (suc n) =
      concatMap (Î» f â†’ map f (interpret gâ‚‚ tg (suc n)))
        (interpret gâ‚ tg (suc n))
    interpret (Pure x    ) tg (suc n) = [ x ]
    interpret (Bind gâ‚ gâ‚‚) tg (suc n) =
      (flip concatMap) (interpret gâ‚ tg (suc n))
        (Î» x â†’ interpret (gâ‚‚ x) tg (suc n))
    interpret (None      ) tg (suc n) = []
    interpret (Î¼         ) tg (suc n) =
      interpret tg tg n
    interpret (` g       ) tg (suc n) =
      interpret g g (suc n)
    interpret âŸ¨ x ` g âŸ© tg (suc n) =
      interpretáµ¢ g x (g x) (suc n)

    -- Interpret a generator as a function from recursive depth to List of elements
    interpretáµ¢ :
      âˆ€ {â„“ k} {i : Set k} {a t : i â†’ Set â„“}
      â†’ ((y : i) â†’ Genáµ¢ t t y) â†’ (x : i) â†’ Genáµ¢ a t x â†’ â„• â†’ List (a x)
    interpretáµ¢ tg x g                    zero = []
    interpretáµ¢ tg x (Noneáµ¢ )            (suc n) = []
    interpretáµ¢ tg x (Pureáµ¢ v)           (suc n) = [ v ]
    interpretáµ¢ tg x (Apáµ¢ {y = y} gâ‚ gâ‚‚) (suc n) =
      concatMap (Î» f â†’ map f (interpretáµ¢ tg y gâ‚‚ (suc n) ))
        (interpretáµ¢ tg x gâ‚ (suc n))
    interpretáµ¢ tg x (Bindáµ¢ {y = y} g f) (suc n) =
      concatMap (Î» v â†’ interpretáµ¢ tg x (f v) (suc n))
        (interpretáµ¢ tg y g (suc n))
    interpretáµ¢ tg x (Oráµ¢ gâ‚ gâ‚‚)         (suc n) =
      merge (interpretáµ¢ tg x gâ‚ (suc n))
        (interpretáµ¢ tg x gâ‚‚ (suc n))
    interpretáµ¢ tg x (Î¼áµ¢ .x)             (suc n) =
      interpretáµ¢ tg x (tg x) n
    interpretáµ¢ tg x (Call g)            (suc n) =
      interpret g g (suc n)
    interpretáµ¢ tg x (Calláµ¢ g y)         (suc n) =
      interpretáµ¢ g y (g y) (suc n)

  -- Interpret a closed generator as a function from `â„•` to `List a`
  âŸ¨_âŸ© : âˆ€ {â„“ k} {a : Set â„“} â†’ Gen {â„“} {k} a a â†’ â„• â†’ List a
  âŸ¨ g âŸ© = interpret g g

  -- Interpretation of closed indexed generators
  âŸ¨_âŸ©áµ¢ : âˆ€ {â„“ k} {i : Set k} {f : i â†’ Set â„“} â†’ ((x : i) â†’ ğ”¾áµ¢ f x) â†’ (x : i) â†’ â„• â†’ List (f x)
  âŸ¨ g âŸ©áµ¢ x = interpretáµ¢ g x (g x)


